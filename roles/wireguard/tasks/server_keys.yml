---
- name: Stat Wireguard private key
  stat:
    path: "{{ wireguard_path }}/privatekey"
  register: _wg_privatekey
  changed_when: false

- name: Generate Wireguard public and private keys, if they do not yet exist
  shell: "set -o pipefail && umask 077; set -o pipefail && wg genkey | tee {{ wireguard_path }}/privatekey | wg pubkey > {{ wireguard_path }}/publickey"
  args:
    executable: /bin/bash
  when: not _wg_privatekey.stat.exists
  notify: restart wireguard

- name: Read server private key into a variable, for templating purposes
  slurp:
    src: "{{ wireguard_path }}/privatekey"
  register: wireguard_server_private_key
  changed_when: false

- name: Read public key into a variable, for templating purposes
  slurp:
    src: "{{ wireguard_path }}/publickey"
  register: wireguard_server_public_key
  changed_when: false
